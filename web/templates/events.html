<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events in National Parks - Parks Explorer</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" href="/static/assets/favicon.ico" sizes="any">
    <link rel="icon" type="image/webp" sizes="16x16" href="/static/assets/favicon-16x16.webp">
    <link rel="icon" type="image/webp" sizes="32x32" href="/static/assets/favicon-32x32.webp">
    <link rel="icon" type="image/webp" sizes="48x48" href="/static/assets/favicon-48x48.webp">
    <link rel="icon" type="image/webp" sizes="96x96" href="/static/assets/favicon-96x96.webp">
    <link rel="icon" type="image/webp" sizes="144x144" href="/static/assets/favicon-144x144.webp">
    
    <!-- Fallback PNG icons for browsers that don't support WebP -->
    <link rel="icon" type="image/png" sizes="16x16" href="/static/assets/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/assets/favicon-96x96.png">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/static/assets/apple-touch-icon.webp">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/assets/apple-touch-icon.png">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/static/site.webmanifest">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#2d5016">
    <meta name="msapplication-TileColor" content="#e2e2e2ff">
    <meta name="msapplication-TileImage" content="/static/assets/favicon-144x144.webp">
    
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://unpkg.com/htmx.org@2.0.3"></script>
    <script>
        // Trigger auth change event after page loads to refresh authentication status
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.body.dispatchEvent(new Event('authChange'));
            }, 100);
        });

        // Add HTMX error handling
        document.addEventListener('htmx:error', function(event) {
            console.error('HTMX Error:', event.detail);
            // Optionally show user-friendly error message
        });

        // Add HTMX before send event to debug requests
        document.addEventListener('htmx:beforeSend', function(event) {
            console.log('HTMX request to:', event.detail.xhr.responseURL || event.detail.pathInfo.requestPath);
        });
    </script>
</head>
<body>
    <!-- Header loaded via HTMX -->
    <div id="header-container"
         hx-get="/api/templates/header"
         hx-trigger="load once"
         hx-headers='{"X-Current-Page": "events"}'
         hx-swap="innerHTML">
    </div>

    <main class="events-page">
        <!-- Hero Section -->
        <section class="events-hero">
            <div class="events-hero-content">
                <h1 class="events-hero-title">Events in National Parks</h1>
                <p class="events-hero-description">
                    Discover a variety of activities and events happening in national parks across the country. 
                    From guided tours to longer programs, there's something for everyone.
                </p>
            </div>
        </section>

        <!-- Search and Filter Section -->
        <section class="events-filters">
            <div class="filters-container">
                <div class="search-controls">
                    <!-- Filter Controls -->
                    <div class="filter-controls">
                        <!-- Park Filter -->
                        <select id="park-filter" 
                                class="filter-select"
                                hx-get="/api/events/search"
                                hx-target="#events-results"
                                hx-trigger="change"
                                hx-include="#event-search, .filter-select">
                            <option value="">All Parks</option>
                            <!-- Options will be loaded dynamically -->
                        </select>

                        <!-- State Filter -->
                        <select id="state-filter" 
                                class="filter-select"
                                hx-get="/api/events/search"
                                hx-target="#events-results"
                                hx-trigger="change"
                                hx-include="#event-search, .filter-select">
                            <option value="">All States</option>
                            <!-- Options will be loaded dynamically -->
                        </select>

                        <!-- Event Type Filter -->
                        <select id="event-type-filter" 
                                class="filter-select"
                                hx-get="/api/events/search"
                                hx-target="#events-results"
                                hx-trigger="change"
                                hx-include="#event-search, .filter-select">
                            <option value="">All Event Types</option>
                            <option value="guided-tour">Guided Tours</option>
                            <option value="educational">Educational Programs</option>
                            <option value="cultural">Cultural Events</option>
                            <option value="recreation">Recreation Activities</option>
                            <option value="special">Special Events</option>
                        </select>

                        <!-- Date Range Filter -->
                        <select id="date-range-filter" 
                                class="filter-select"
                                hx-get="/api/events/search"
                                hx-target="#events-results"
                                hx-trigger="change"
                                hx-include="#event-search, .filter-select">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="this-week">This Week</option>
                            <option value="this-month">This Month</option>
                            <option value="next-month">Next Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- Calendar and Results Section -->
        <section class="events-main-content">
            <div class="events-content-container">
                <!-- Calendar View -->
                <div class="events-calendar-section">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button class="calendar-nav-btn" id="prev-month" onclick="navigateMonth(-1)">‹</button>
                            <h3 class="calendar-title" id="calendar-title">July 2024</h3>
                            <button class="calendar-nav-btn" id="next-month" onclick="navigateMonth(1)">›</button>
                        </div>
                        
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Calendar will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Events List -->
                <div class="events-list-section">
                    <div id="events-results" 
                         hx-get="/api/events/search"
                         hx-trigger="load once"
                         hx-swap="innerHTML">
                        <!-- Events will be loaded here -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer loaded via HTMX -->
    <div id="footer-container"
         hx-get="/api/templates/footer"
         hx-trigger="load once"
         hx-swap="innerHTML">
    </div>

    <script src="/static/script.js"></script>
    <script>
        // Calendar functionality
        let currentDate = new Date();
        let selectedDate = null;

        function initializeCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            if (!calendarGrid) {
                console.warn('Calendar grid not found, retrying in 500ms');
                setTimeout(initializeCalendar, 500);
                return;
            }
            updateCalendar();
            loadEventsForDate(currentDate);
        }

        function navigateMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            updateCalendar();
            loadEventsForMonth();
        }

        function updateCalendar() {
            const calendarTitle = document.getElementById('calendar-title');
            if (!calendarTitle) {
                return;
            }
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update calendar title
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            calendarTitle.textContent = `${monthNames[month]} ${year}`;
            
            // Generate calendar grid
            generateCalendarGrid(year, month);
        }

        function generateCalendarGrid(year, month) {
            const grid = document.getElementById('calendar-grid');
            if (!grid) {
                return;
            }
            
            grid.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                grid.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const dayDate = new Date(year, month, day);
                
                // Highlight today
                if (dayDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Add click handler
                dayElement.onclick = () => selectDate(dayDate, dayElement);
                
                grid.appendChild(dayElement);
            }
        }

        function selectDate(date, element) {
            // Remove previous selection
            document.querySelectorAll('.calendar-day.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selection to clicked date
            element.classList.add('selected');
            selectedDate = date;
            
            // Load events for selected date
            loadEventsForDate(date);
        }

        function loadEventsForDate(date) {
            const eventsResults = document.getElementById('events-results');
            if (!eventsResults) {
                return;
            }
            
            const formattedDate = date.toISOString().split('T')[0];
            htmx.ajax('GET', `/api/events/search?date=${formattedDate}`, {
                target: '#events-results',
                swap: 'innerHTML'
            });
        }

        function loadEventsForMonth() {
            const eventsResults = document.getElementById('events-results');
            if (!eventsResults) {
                return;
            }
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1; // JS months are 0-indexed
            const startDate = `${year}-${month.toString().padStart(2, '0')}-01`;
            const endDate = new Date(year, month, 0).toISOString().split('T')[0];
            
            htmx.ajax('GET', `/api/events/search?start_date=${startDate}&end_date=${endDate}`, {
                target: '#events-results',
                swap: 'innerHTML'
            });
        }

        function clearAllFilters() {
            // Reset all filter inputs - check if elements exist first
            const eventSearch = document.getElementById('event-search');
            const parkFilter = document.getElementById('park-filter');
            const stateFilter = document.getElementById('state-filter');
            const eventTypeFilter = document.getElementById('event-type-filter');
            const dateRangeFilter = document.getElementById('date-range-filter');
            const eventsResults = document.getElementById('events-results');
            
            if (eventSearch) eventSearch.value = '';
            if (parkFilter) parkFilter.value = '';
            if (stateFilter) stateFilter.value = '';
            if (eventTypeFilter) eventTypeFilter.value = '';
            if (dateRangeFilter) dateRangeFilter.value = '';
            
            // Trigger search with cleared filters only if events-results exists
            if (eventsResults) {
                htmx.ajax('GET', '/api/events/search', {
                    target: '#events-results',
                    swap: 'innerHTML'
                });
            }
        }

        // Initialize calendar when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure all HTMX requests have started
            setTimeout(() => {
                initializeCalendar();
            }, 100);
        });
    </script>
</body>
</html>
